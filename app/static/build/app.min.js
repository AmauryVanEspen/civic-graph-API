!function(t){"use strict";t.module("civic-graph",["ui.bootstrap","leaflet-directive","ngAnimate"]).constant("_",window._).config(["$locationProvider","$httpProvider","$compileProvider",function(t,e,o){t.html5Mode(!0),e.defaults.headers.common["X-Requested-With"]="XMLHttpRequest",o.debugInfoEnabled(!0)}]).filter("thousandSuffix",function(){return function(t,e){var o,i=["k","M","G","T","P","E"];return window.isNaN(t)?null:t<1e3?t:(o=Math.floor(Math.log(t)/Math.log(1e3)),(t/Math.pow(1e3,o)).toFixed(e)+i[o-1])}})}(angular);
!function(e){"use strict";function n(e,n){e.itemsShownDefault={key_people:3,grants_given:3,grants_received:3,investments_made:3,investments_received:3,collaborations:3,employments:3,relations:3,data_given:3,data_received:3,revenues:3,expenses:3},e.itemsShown=n.clone(e.itemsShownDefault),e.$on("entityChange",function(){e.itemsShown=n.clone(e.itemsShownDefault)}),e.showMore=function(n){e.itemsShown[n]=e.currentEntity[n].length},e.showLess=function(n){e.itemsShown[n]=e.itemsShownDefault[n]}}e.module("civic-graph").controller("detailsCtrl",["$scope","_",n])}(angular);
!function(t){"use strict";function n(t,n,e,i){t.updating=!1,t.error=!1,t.addressSearch=function(t){return n.jsonp("http://dev.virtualearth.net/REST/v1/Locations",{params:{query:t,key:"Ai58581yC-Sr7mcFbYTtUkS3ixE7f6ZuJnbFJCVI4hAtW1XoDEeZyidQz2gLCCyD",jsonp:"JSON_CALLBACK",incl:"ciso2"}}).then(function(t){return t.data.resourceSets[0].resources})},t.changeType=function(){"Individual"===t.editEntity.type&&(t.editEntity.locations=[],t.addLocation(t.editEntity.locations))},t.setLocation=function(n,e){n.full_address="formattedAddress"in e.address&&"Individual"!==t.editEntity.type?e.address.formattedAddress:null,n.address_line="addressLine"in e.address&&"Individual"!==t.editEntity.type?e.address.addressLine:null,n.locality="locality"in e.address?e.address.locality:null,n.district="adminDistrict"in e.address?e.address.adminDistrict:null,n.postal_code="postalCode"in e.address?e.address.postalCode:null,n.country="countryRegion"in e.address?e.address.countryRegion:null,n.country_code="countryRegionIso2"in e.address?e.address.countryRegionIso2:null,n.coordinates="point"in e?e.point.coordinates:null,"Individual"===t.editEntity.type&&(n.full_address=n.locality?n.district?n.locality+", "+n.district:n.locality:n.country)},t.addLocation=function(t){i.some(t,{full_address:"",id:null})||t.push({full_address:"",id:null})},t.editCategories=i.map(t.categories,function(n){return{name:n.name,enabled:i.some(t.editEntity.categories,{name:n.name}),id:n.id}}),t.addKeyPerson=function(){i.some(t.editEntity.key_people,{name:"",id:null})||t.editEntity.key_people.push({name:"",id:null})},t.setFundingConnection=function(t,n){n.entity_id=t.id},t.addFundingConnection=function(t){i.some(t,{entity:""})||t.push({entity:"",amount:null,year:null,id:null})},t.setConnection=function(t,n){n.entity_id=t.id},t.addConnection=function(t){i.some(t,{entity:"",id:null})||t.push({entity:"",id:null,details:null})},t.addFinance=function(t){i.every(t,function(t){return t.amount>0&&t.year>1750})&&t.push({amount:null,year:null,id:null})},t.addBlankFields=function(){t.addLocation(t.editEntity.locations),t.addKeyPerson(),t.addFundingConnection(t.editEntity.grants_received),t.addFundingConnection(t.editEntity.investments_received),t.addFundingConnection(t.editEntity.grants_given),t.addFundingConnection(t.editEntity.investments_made),t.addConnection(t.editEntity.data_given),t.addConnection(t.editEntity.data_received),t.addConnection(t.editEntity.collaborations),t.addConnection(t.editEntity.employments),t.addConnection(t.editEntity.relations),t.addFinance(t.editEntity.revenues),t.addFinance(t.editEntity.expenses)},t.addBlankFields(),t.isValid=function(){function n(t){var n=!0;return i.each(t,function(t){i.each(t,function(t){t.entity||""===t.entity||(n=!1)})}),n}var e=[t.editEntity.collaborations,t.editEntity.employments,t.editEntity.relations,t.editEntity.data_received,t.editEntity.data_given,t.editEntity.grants_given,t.editEntity.grants_received,t.editEntity.investments_made,t.editEntity.investments_received];return null!==t.editEntity.type&&t.editEntity.name&&t.editEntity.name.length>0&&n(e)};var d=function(t){i.forEach(t,function(t){try{t.amount=Number(t.amount.replace(",",""))}catch(n){}})};t.removeEmpty=function(){i.forEach(["grants_received","investments_received","grants_given","investments_made","revenues","expenses"],function(n){d(t.editEntity[n])}),t.editEntity.categories=i.filter(t.editCategories,"enabled"),i.remove(t.editEntity.locations,function(t){return""===t.full_address}),i.remove(t.editEntity.key_people,function(t){return""===t.name}),i.remove(t.editEntity.grants_received,function(t){return""===t.entity}),i.remove(t.editEntity.investments_received,function(t){return""===t.entity}),i.remove(t.editEntity.grants_given,function(t){return""===t.entity}),i.remove(t.editEntity.investments_made,function(t){return""===t.entity}),i.remove(t.editEntity.data_given,function(t){return""===t.entity}),i.remove(t.editEntity.data_received,function(t){return""===t.entity}),i.remove(t.editEntity.collaborations,function(t){return""===t.entity}),i.remove(t.editEntity.employments,function(t){return""===t.entity}),i.remove(t.editEntity.relations,function(t){return""===t.entity}),i.remove(t.editEntity.revenues,function(t){return t.amount<=0||t.year<1750}),i.remove(t.editEntity.expenses,function(t){return t.amount<=0||t.year<1750})},t.savetoDB=function(){t.updating=!0,n.post("api/save",{entity:t.editEntity}).success(function(n){t.setEntities(n.nodes),t.setEntityID(t.editEntity.id),t.$broadcast("entitiesLoaded"),t.updating=!1}).error(function(){console.log("ERROR"),t.error=!0,e(function(){t.error=!1,t.updating=!1,t.addBlankFields()},2e3)})},t.cancelEdit=function(){t.removeEmpty(),t.stopEdit()},t.save=function(){t.removeEmpty(),t.savetoDB()}}t.module("civic-graph").controller("editCtrl",["$scope","$http","$timeout","_",n])}(angular);
!function(t){"use strict";function e(t,e,i,n,o){t.random=(new Date).getTime(),t.entities=[],t.searchItems=null,t.categories=[],t.currentLocation=null,t.clickedLocation={},t.clickedLocation.location=null,t.clickedEntity={},t.clickedEntity.entity=null,t.connections={},t.editing=!1,t.actions={interacted:!1},t.showsearchMB=!1,t.hydePartials=function(e){"search"===e?(t.editing=!1,t.settingsEnabled=!1):"settings"===e?(t.editing=!1,t.showsearchMB=!1):"edit"===e?(t.settingsEnabled=!1,t.showsearchMB=!1):(t.editing=!1,t.settingsEnabled=!1,t.showsearchMB=!1)},t.showSearch=function(){t.hydePartials("search"),t.showsearchMB=!t.showsearchMB,t.$broadcast("hideLicense")},t.toggleSettings=function(){t.hydePartials("settings"),t.settingsEnabled=!t.settingsEnabled},t.startEdit=function(e){var i;t.mobile&&t.hydePartials("edit"),e?t.editEntity=e:(i={},o.forEach(t.entities[0],function(t,e){i[e]=o.isArray(t)?[]:null}),t.editEntity=i),t.editing=!t.editing},t.switchView=function(){t.changeView(t.showView.Network?"Map":"Network")},window.mobilecheck=function(){var t=!1,e=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i,i=/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i;return function(n){(e.test(n)||i.test(n.substr(0,4)))&&(t=!0)}(navigator.userAgent||navigator.vendor||window.opera),t},t.mobile=window.mobilecheck(),t.settingsEnabled=!t.mobile,t.getURLID=function(){var t=i.search().entityID;return t&&(t=parseInt(t)),t},setTimeout(function(){e.get("api/entities").success(function(e){t.entities=e.nodes;var i=o.uniq(o.pluck(o.flatten(o.pluck(t.entities,"locations")),"locality")),n=o.map(i,function(e){var i=o.filter(t.entities,o.flow(o.property("locations"),o.partialRight(o.any,{locality:e})));return{name:e,type:"location",entities:i,dict:o.zipObject(o.pluck(i,"name"),o.pluck(i,"index"))}});t.searchItems=n.concat(t.entities),t.getURLID()&&t.setEntityID(t.getURLID()),t.overviewUrl="partials/overview.html?i="+t.random,t.$broadcast("entitiesLoaded")})},100),t.entityTypes={Government:!0,"For-Profit":!0,"Non-Profit":!0,Individual:!0},t.connectionTypes={Funding:!0,Data:!0,Employment:!0,Collaboration:!0},t.influenceTypes=["Local","National","Global"],t.sizeBys=[{name:"Employees",value:"employees"},{name:"Twitter Followers",value:"followers"}],t.sizeBy="employees",t.showView={Network:!0,Map:!1},t.overviewUrl=null,t.changeView=function(e){o.forEach(o.keys(t.showView),function(i){t.showView[i]=e===i}),t.$broadcast("viewChange")},t.setEntity=function(e){t.currentLocation=null,t.currentEntity=e,t.editing&&t.stopEdit(),t.$broadcast("entityChange")},t.setEntityID=function(e){t.setEntity(o.find(t.entities,{id:e}))},t.setLocation=function(e){t.currentLocation=e,t.editing&&t.stopEdit(),t.$broadcast("itemChange")},t.selectItem=function(e){"location"===e.type?t.setLocation(e):t[e%1===0?"setEntityID":"setEntity"](e),t.$broadcast("selectItem",e)},t.$on("setCurrentEntity",function(e,i){t.currentEntity=i.value}),t.$on("setCurrentLocation",function(e,i){t.currentLocation=i.value}),t.setEntities=function(e){t.entities=e},t.stopEdit=function(){t.editing=!1},t.changeSizeBy=function(){t.$broadcast("changeSizeBy",t.sizeBy)},t.toggleLink=function(e){t.$broadcast("toggleLink",{name:e,enabled:t.connectionTypes[e]})},t.toggleNode=function(e){t.$broadcast("toggleNode",{name:e,enabled:t.entityTypes[e]})},t.animationsEnabled=!0,t.showAbout=function(){n.open({animation:!1,templateUrl:"partials/about.html?i="+t.random,controller:"modalCtrl"})},e.get("api/categories").success(function(e){t.categories=e.categories}),t.safeApply=function(t){var e=this.$root.$$phase;"$apply"===e||"$digest"===e?t&&"function"==typeof t&&t():this.$apply(t)}}t.module("civic-graph").controller("homeCtrl",["$scope","$http","$location","$modal","_",e])}(angular);
!function(t,e,n){"use strict";function i(t,i,o,r){t.options={center:{lat:20,lng:-40,zoom:3},defaults:{tileLayer:"https://api.tiles.mapbox.com/v4/mapbox.light/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZGF2aWRscm50IiwiYSI6IjA0M2RkNzMzZWJmNzEzNGYzMTdhYTExYzAyZmU4ZTE1In0.TNYlFta2VItrkn4L0Z9BJQ",tileLayerOptions:{detectRetina:!0,reuseTiles:!1},zoomControl:!1,attributionControl:!1}},i(function(){var i=function(t){var n=t.data,i=e.layout.pie().sort(null).value(function(t){return t.value}),o=e.svg.arc().outerRadius(t.r).innerRadius(t.r-10),r=t.r+t.strokeWidth,a=2*r,c=a,l=document.createElementNS(e.ns.prefix.svg,"svg"),s=e.select(l).data(n).attr("class","piechart").attr("width",a).attr("height",c),u=s.selectAll(".arc").data(i(n)).enter().append("g").attr("class","arc").attr("transform","translate("+r+","+r+")");return u.append("path").attr("d",o).attr("class",function(t){return t.data.type+"-arc"}),u.append("svg:text").text(function(e,n){if(0===n)return t.count}).attr("x",-4*t.count.toString().length).attr("dy",5).attr("class","arcText"),window.XMLSerializer?(new window.XMLSerializer).serializeToString(l):l.xml?l.xml:""};o.getMap().then(function(e){function o(t){t.preventDefault()}e.invalidateSize(),new n.Control.Zoom({position:"topright"}).addTo(e),n.control.locate({position:"topright",showPopup:!1,icon:"fa fa-location-arrow"}).addTo(e);var a=function(t){var e=t.getAllChildMarkers(),o=e.length,a=r.pluck(e,"options"),c=r.map(r.countBy(a,"type"),function(t,e){return{type:e,value:t}}),l=28,s=1,u=2*(l+s),d=i({data:c,r:l,strokeWidth:s,count:o});return new n.DivIcon({html:d,className:"marker-cluster",iconSize:new n.point(u,u)})},c={"Non-Profit":n.icon({iconUrl:"img/marker-nonprof.svg",iconSize:[60,60]}),"For-Profit":n.icon({iconUrl:"img/marker-prof.svg",iconSize:[60,60]}),Individual:n.icon({iconUrl:"img/marker-ind.svg",iconSize:[60,60]}),Government:n.icon({iconUrl:"img/marker-gov.svg",iconSize:[60,60]})},l=n.markerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!1,iconCreateFunction:a,maxClusterRadius:30,spiderfyDistanceMultiplier:1.3});r.forEach(t.entities,function(t){r.forEach(t.locations,function(e){if(r.every(e.coordinates)){40.782===e.coordinates[0].toFixed(5)&&e.coordinates[1].toFixed(5)===-73.8317&&(e.coordinates[0]=40.77065,e.coordinates[1]=-73.97406);var i=n.marker(e.coordinates,{icon:c[t.type],title:t.name,entity_id:t.id,message:t.name,type:t.type});l.addLayer(i)}})}),e.addLayer(l),e.on("locationerror",o),e.locate({setView:!0,maxZoom:11}),l.on("clusterclick",function(t){}),l.on("click",function(e){t.setEntityID(e.layer.options.entity_id),t.clickedEntity.entity=t.currentEntity,t.actions.interacted=!0,t.settingsEnabled&&t.mobile&&t.toggleSettings(),t.safeApply()}),e.on("click",function(){t.clickedEntity.entity=null,t.actions.interacted=!0,t.safeApply()}),t.$on("selectItem",function(){var n=t.currentEntity.locations.length>0?r.pluck(t.currentEntity.locations,"coordinates"):null;n.length>0&&e.setView(n[0],11),t.actions.interacted=!0,t.safeApply()})})})}t.module("civic-graph").controller("mapCtrl",["$scope","$timeout","leafletData","_",i])}(angular,d3,L);
!function(o){"use strict";function c(o,c){o.closeWindow=function(){c.close()}}o.module("civic-graph").controller("modalCtrl",["$scope","$modalInstance",c])}(angular);
!function(t){"use strict";function e(t,e){t.loading=!0,t.showLicense=!0,t.$on("hideLicense",function(){t.showLicense=!1}),t.$on("entitiesLoaded",function(){e.get("api/connections").success(function(e){_.forEach(_.keys(e.connections),function(e){t.connections[e]=[]}),_.forEach(e.connections,function(e,n){_.forEach(e,function(e){var i=_.find(t.entities,{id:e.source}),c=_.find(t.entities,{id:e.target});t.connections[n].push({source:i,target:c})})}),_.forEach(_.keys(t.entityTypes),function(e){var n=_.takeRight(_.sortBy(_.filter(t.entities,{type:e}),"collaborations.length"),5);_.forEach(n,function(t){t.wellconnected=!0})}),t.entities=_.sortBy(t.entities,function(t){return t.wellconnected?1:0}),t.mobile?n():i()})});var n=function(){var e={nodes:t.entities,links:_.flatten(_.values(t.connections))},n={Government:{focused:"rgba(242, 80, 34, 1)",unfocused:"rgba(242, 80, 34, 0.1)"},"Non-Profit":{focused:"rgba(30, 144, 255, 1)",unfocused:"rgba(30, 144, 255, 0.1)"},"For-Profit":{focused:"rgba(127, 186, 0, 1)",unfocused:"rgba(127, 186, 0, 0.1)"},Individual:{focused:"rgba(255, 175, 44, 1)",unfocused:"rgba(255, 175, 44, 0.1)"},Funding:{focused:"#FF7460",unfocused:"#E3DFE4"},Data:{focused:"#84C2FF",unfocused:"#E3DFE4"},Employment:{focused:"#EE73FF",unfocused:"#E3DFE4"},Collaboration:{focused:"#FFD955",unfocused:"#E3DFE4"}},i=$("#canvas-force").width(),c=$("#canvas-force").height(),o={Government:[-90,-90-c/7],"Non-Profit":[-90,90-c/7],"For-Profit":[90,-90-c/7],Individual:[90,90-c/7]},a=function(t,e,n,i,c){var o=t-n,a=e-i;return o*o+a*a<=c*c},r={employees:function(t){return t>10?Math.log(t)/3:1.5},followers:function(t){return t>0&&t<=500?1.5:t>500&&t<=5e3?1.8:t>5e3&&t<=1e4?2:t>1e4&&t<=25e3?2.5:t>25e3&&t<=9e5?3:t>9e5?5:1}},s=d3.select("div#canvas-force").append("canvas"),u=s.node().getContext("2d"),l=window.devicePixelRatio||1,d=u.webkitBackingStorePixelRatio||u.mozBackingStorePixelRatio||u.msBackingStorePixelRatio||u.oBackingStorePixelRatio||u.backingStorePixelRatio||1,y=l/d;s.attr("width",i*y).attr("height",c*y).attr("id","networkCanvas");var f=document.getElementById("networkCanvas");f.style.width=i+"px",f.style.height=c+"px",u.scale(y,y),t.loading=!1;var p=1;$("#networkCanvas").click(function(n){var i=n.offsetX/p,c=n.offsetY/p;t.showLicense=!1,t.clickedEntity.entity=null;var s=!1;e.nodes.forEach(function(e){var n=r[t.sizeBy](e[t.sizeBy]);a(i,c,e.x+o[e.type][0],e.y+o[e.type][1],4.5*n)&&(t.hydePartials(),t.$emit("setCurrentEntity",{value:e}),s=!0,t.setEntity(e),t.clickedEntity.entity=e,focus(e))}),s||(t.$emit("setCurrentLocation",{value:null}),t.$emit("setCurrentEntity",{value:null})),x(),t.actions.interacted=!0,t.safeApply(),$("#details-panel").scrollTop(0)});var h=0,m=!0,g=[],k=[];e.nodes.forEach(function(e){t.entityTypes[e.type]&&(t.currentLocation?e.name in t.currentLocation.dict&&g.push(e):t.currentEntity&&!showEntities[e.id]&&e!==t.currentEntity||(t.currentEntity||e.wellconnected?g.push(e):k.push(e)))}),k=k.concat(g);var x=function(){h++,h>70&&m&&(m=!1,E.stop(),new RTP.PinchZoom($("#networkCanvas"),{})),u.clearRect(0,0,i,c);var e={};u.strokeStyle="#ccc",_.forEach(t.connections,function(a,s){a.forEach(function(a){if(t.connectionTypes[s]&&t.entityTypes[a.target.type]&&t.entityTypes[a.source.type])if(t.currentLocation){if(a.source.name in t.currentLocation.dict&&a.target.name in t.currentLocation.dict){u.beginPath();var l=r[t.sizeBy](a.source[t.sizeBy]);u.moveTo(Math.max(4.5*l,Math.min(i-4.5*l,a.source.x+o[a.source.type][0])),Math.max(4.5*l,Math.min(c-4.5*l,a.source.y+o[a.source.type][1]))),u.lineTo(Math.max(4.5*l,Math.min(i-4.5*l,a.target.x+o[a.target.type][0])),Math.max(4.5*l,Math.min(c-4.5*l,a.target.y+o[a.target.type][1]))),u.strokeStyle=n[s].focused,u.stroke(),u.closePath()}}else if(!t.currentEntity||a.source==t.currentEntity||a.target==t.currentEntity){u.beginPath();var l=r[t.sizeBy](a.source[t.sizeBy]);u.moveTo(Math.max(4.5*l,Math.min(i-4.5*l,a.source.x+o[a.source.type][0])),Math.max(4.5*l,Math.min(c-4.5*l,a.source.y+o[a.source.type][1]))),u.lineTo(Math.max(4.5*l,Math.min(i-4.5*l,a.target.x+o[a.target.type][0])),Math.max(4.5*l,Math.min(c-4.5*l,a.target.y+o[a.target.type][1]))),u.strokeStyle=n[s].focused,u.stroke(),u.closePath(),e[a.source.id]=!0,e[a.target.id]=!0}})});var a=[];k.forEach(function(s){if(t.entityTypes[s.type]){var l;t.currentLocation?s.name in t.currentLocation.dict?(l="focused",u.strokeStyle="white",a.push(s)):(u.strokeStyle="rgba(255, 255, 255, 0.1)",l="unfocused"):!t.currentEntity||e[s.id]||s===t.currentEntity?(l="focused",u.strokeStyle="white",t.currentEntity?a.push(s):s.wellconnected&&a.push(s)):(u.strokeStyle="rgba(255, 255, 255, 0.1)",l="unfocused");var d=r[t.sizeBy](s[t.sizeBy]);u.beginPath(),u.fillStyle=n[s.type][l],u.arc(Math.max(4.5*d,Math.min(i-4.5*d,s.x+o[s.type][0])),Math.max(4.5*d,Math.min(c-4.5*d,s.y+o[s.type][1])),4.5*d,0,2*Math.PI),u.fill(),u.lineWidth=1,u.stroke(),u.closePath()}}),_.forEach(a,function(e){var n=r[t.sizeBy](e[t.sizeBy]);u.strokeStyle="#333333";var a=e.nickname?e.nickname:e.name;u.font="lighter 11px Segoe UI, HelveticaNeue-Light, sans-serif-light, sans-serif",u.strokeText(a,Math.max(4.5*n,Math.min(i-4.5*n,e.x+o[e.type][0]))-2*a.length,Math.max(4.5*n,Math.min(c-4.5*n,e.y+o[e.type][1]))+10,100)})},E=d3.layout.force().size([i,c]).nodes(e.nodes).links(e.links).on("tick",x).charge(-2).linkStrength(.1).linkDistance(50).start();t.$on("toggleNode",function(t,e){x()}),t.$on("toggleLink",function(t,e){x()}),t.$on("changeSizeBy",function(t,e){x()}),t.$on("selectItem",function(e,n){"location"===n.type?(t.clickedLocation.location=t.currentLocation,t.$emit("setCurrentEntity",{value:null})):(t.clickedEntity.entity=t.currentEntity,t.$emit("setCurrentLocation",{value:null})),t.actions.interacted=!0,t.safeApply(),x()})},i=function(){t.loading=!1;var e=d3.select("#network"),n=e.node().getBoundingClientRect(),i=n.height,c=n.width,o=6,a=7,r={Individual:{x:1,y:1},"For-Profit":{x:1,y:-1},"Non-Profit":{x:-1,y:1},Government:{x:-1,y:-1}},s=10,u=50,l=d3.max(t.entities,function(t){return parseInt(t.employees)}),d=d3.max(t.entities,function(t){return parseInt(t.followers)}),y={employees:d3.scale.sqrt().domain([10,l]).range([s,u]),followers:d3.scale.sqrt().domain([10,d]).range([s,u])},f={},p=d3.layout.force().size([c,i]).nodes(t.entities).links(_.flatten(_.values(t.connections))).charge(function(t){return t.employees?-2*y.employees(t.employees):-20}).linkStrength(0).linkDistance(50);_.forEach(t.connections,function(t,n){f[n]=e.selectAll(".link ."+n+"-link").data(t).enter().append("line").attr("class",function(t){return t.type=n,"link "+n+"-link "+t.source.type+"-link "+t.target.type+"-link"})});var h=e.selectAll(".node").data(t.entities).enter().append("g").attr("class",function(t){return"node "+t.type+"-node"}).call(p.drag);h.append("circle").attr("r",function(t){return t.employees?y.employees(t.employees):a}),h.append("text").text(function(t){return t.nickname?t.nickname:t.name}).attr("dx",function(t){return-.065*this.getComputedTextLength()/2+"em"}).attr("dy",function(t){return.08*this.parentNode.getBBox().height/2+.5+"em"}),p.on("tick",function(e){var n=o*e.alpha;_.forEach(t.entities,function(t){t.x&&r[t.type]&&(t.x+=r[t.type].x*n,t.y+=r[t.type].y*n,t.x=Math.max(u,Math.min(c-u,t.x)),t.y=Math.max(u,Math.min(i-u,t.y)))}),_.forEach(f,function(t,e){t.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y})}),h.attr("transform",function(t){return"translate("+t.x+","+t.y+")"})});var m=function(t){requestAnimationFrame(function e(){for(var n=0;n<t;n++)p.tick();p.alpha()>0&&requestAnimationFrame(e)})};t.mobile||m(7),p.start();var g={};_.forEach(f,function(t,e){_.forEach(t[0],function(t){var e=t.__data__.source,n=t.__data__.target;g[e.index+","+n.index]=!0,g[n.index+","+e.index]=!0})});var k,x=function(t,e){return g[t.index+","+e.index]|t.index==e.index},E=function(t){h.classed("focused",function(e){return x(t,e)}).classed("unfocused",function(e){return!x(t,e)}),_.forEach(f,function(e,n){e.classed("focused",function(e){return t.index==e.source.index|t.index==e.target.index}).classed("unfocused",function(e){return!(t.index==e.source.index|t.index==e.target.index)})})},v=function(e){t.currentEntity!=e&&t.setEntity(e),t.safeApply(),E(e)},L=function(e){h.classed("focused",!1).classed("unfocused",!1),_.forEach(f,function(t,e){t.classed("focused",!1).classed("unfocused",!1)}),e.fixed=!1,t.clickedEntity.entity&&p.resume()},w=function(e){t.clickedEntity.entity||t.editing||t.currentLocation||(k=setTimeout(function(){v(e)},500)),t.actions.interacted=!0,t.safeApply()},M=function(e){t.clickedEntity.entity||t.currentLocation||(L(e),clearTimeout(k)),t.actions.interacted=!0,t.safeApply()},T=function(e){t.safeApply(),h.classed("focused",function(t){return t.name in e.dict}).classed("unfocused",function(t){return!(t.name in e.dict)}),_.forEach(f,function(t,n){t.classed("focused",function(t){return t.source.name in e.dict&&t.target.name in e.dict}).classed("unfocused",function(t){return!(t.source.name in e.dict&&t.target.name in e.dict)})})},b=function(e){h.classed("focused",!1).classed("unfocused",!1),_.forEach(f,function(t,e){t.classed("focused",!1).classed("unfocused",!1)}),t.clickedLocation.location&&p.resume()},P=function(e){t.showLicense=!1,t.clickedEntity.entity&&(L(t.clickedEntity.entity),t.clickedEntity.entity=null),t.clickedLocation.location!==e&&(b(t.clickedLocation.location),t.clickedLocation.location=e,T(e)),d3.event&&d3.event.stopPropagation(),t.actions.interacted=!0,t.safeApply()},B=function(e){t.showLicense=!1,t.clickedLocation.location&&(b(t.clickedLocation.entity),t.clickedLocation.location=null),t.clickedEntity.entity==e?t.clickedEntity.entity=null:(t.clickedEntity.entity&&L(t.clickedEntity.entity),t.clickedEntity.entity=e,v(e)),d3.event&&d3.event.stopPropagation(),t.actions.interacted=!0,t.safeApply()},$=function(){t.clickedLocation.location&&(L(t.clickedLocation.location),t.clickedLocation.location=null),t.clickedEntity.entity&&(L(t.clickedEntity.entity),t.clickedEntity.entity=null),t.safeApply()},S=function(e){0==e.fixed?(e.x=c/2,e.y=i/2,e.px=c/2,e.py=i/2,e.fixed=!0,t.clickedEntity.entity=e):L(e),t.actions.interacted=!0,t.safeApply()};h.on("mouseover",w),h.on("mouseout",M),h.on("click",B),h.on("dblclick",S),e.on("click",$),h.classed("wellconnected",function(t){return t.hasOwnProperty("wellconnected")}),t.$on("changeSizeBy",function(t,n){e.selectAll("circle").transition().duration(250).attr("r",function(t){return t[n]?y[n](t[n]):a})}),t.$on("toggleLink",function(n,i){_.map(t.entityTypes,function(n,i){e.selectAll("."+i+"-link").classed({visible:function(e){return!t.connectionTypes[e.type]||t.entityTypes[e.source.type]&&t.entityTypes[e.target.type]},hidden:function(e){return!t.connectionTypes[e.type]||!t.entityTypes[e.source.type]||!t.entityTypes[e.target.type]}})})}),t.$on("toggleNode",function(n,i){e.selectAll("."+i.name+"-node").classed({visible:i.enabled,hidden:!i.enabled}),e.selectAll("."+i.name+"-link").classed({visible:function(e){return t.connectionTypes[e.type]&&t.entityTypes[e.source.type]&&t.entityTypes[e.target.type]},hidden:function(e){return!t.connectionTypes[e.type]||!t.entityTypes[e.source.type]||!t.entityTypes[e.target.type]}})}),t.$on("selectItem",function(e,n){"location"===n.type?P(t.currentLocation):B(t.currentEntity)}),t.getURLID()&&B(t.currentEntity)}}t.module("civic-graph").controller("networkCtrl",["$scope","$http",e])}(angular);
!function(e){"use strict";function t(e,t){e.categorizedEntities={},t.forEach(t.keys(e.entityTypes),function(i){e.categorizedEntities[i]=t.filter(e.entities,{type:i})})}e.module("civic-graph").controller("overviewCtrl",["$scope","_",t])}(angular);
!function(i,t){"use strict";function s(i){function s(){var i=t(this);i.css("height","55vh")}function c(){var i=t(this);window.innerHeight/3>parseInt(i.css("height"))?i.css("height","55vh"):i.css("height","30vh")}var e;i.mobile&&(e=t("#details-panel"),e.css("height","30vh"),e.scrollTop(0),e.scroll(s),e.click(c))}function c(){return{restrict:"A",link:s}}i.module("civic-graph").directive("addMobileEvents",[c])}(angular,$);